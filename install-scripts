#!/bin/bash

# Parameters
SYSTEM_ENV_SCRIPT=/etc/bash.bashrc
TARGET_USER=carma
CARMA_INSTALL_ROOT=/opt/carma

# Export global environment variables
CARMA_UTILITIES_ROOT=$CARMA_INSTALL_ROOT/carma-utils
CARMA_SCRIPT_ROOT=$CARMA_UTILITIES_ROOT/scripts
CARMA_DOCKER_ROOT=$CARMA_UTILITIES_ROOT/docker

# Ensure installation directories are made
sudo mkdir -p $CARMA_INSTALL_ROOT/carma-utils
sudo chown $TARGET_USER:$TARGET_USER -R $CARMA_INSTALL_ROOT

echo "export CARMA_INSTALL_ROOT=$CARMA_INSTALL_ROOT" | sudo tee -a $SYSTEM_ENV_SCRIPT
echo "export CARMA_UTILITIES_ROOT=$CARMA_UTILITIES_ROOT" | sudo tee -a $SYSTEM_ENV_SCRIPT
echo "export CARMA_SCRIPT_ROOT=$CARMA_SCRIPT_ROOT" | sudo tee -a $SYSTEM_ENV_SCRIPT
echo "export CARMA_DOCKER_ROOT=$CARMA_DOCKER_ROOT" | sudo tee -a $SYSTEM_ENV_SCRIPT

# Locate utility scripts
echo "export PATH=\$PATH:\$(find $CARMA_UTILITIES_ROOT -type d -name \"scripts\" | xargs -n 1 -I % sh -c \"find % -type d\" | xargs | tr \" \" \":\")" | sudo tee -a $SYSTEM_ENV_SCRIPT

# Install ssh key
mkdir $HOME/.ssh

echo "" >>~/.ssh/id_rsa
echo "" >>~/.ssh/id_rsa.pub
echo "|1|KA+8tx01ypb1PnmD5TBc7cwCauk=|G2Uqp0FT5Hur5X7lXGCJutzN8dc= ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBEmKSENjQEezOmxkZMy7opKgwFB9nkt5YRrYMjNuG5N87uRgg6CLrbo5wAdT/y6v0mKV0U2w0WZ2YB/++Tpockg=
      |1|TSNjuRln61SApWtbWPu2Ufj4gbI=|MY0iMvQYujxAyN2BKEcgzyNFFDI= ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBEmKSENjQEezOmxkZMy7opKgwFB9nkt5YRrYMjNuG5N87uRgg6CLrbo5wAdT/y6v0mKV0U2w0WZ2YB/++Tpockg=
" >> ~/.ssh/known_hosts

# Enforce ssh key permissions
chmod -w ~/
chmod 700 -R ~/.ssh
find ~/.ssh/ -name "id_*" -exec chmod 600 {} +
find ~/.ssh/ -name "id*pub*" -exec chmod 644 {} +
touch  ~/.ssh/authorized_keys  ~/.ssh/known_hosts
chmod 640 ~/.ssh/authorized_keys
chmod 640 ~/.ssh/known_hosts

ls -la ~/.ssh/id_rsa*

# Download the carma-utilities repository
git clone git@github.com:davidgayman/carma-utilities-dg.git $CARMA_UTILITIES_ROOT
